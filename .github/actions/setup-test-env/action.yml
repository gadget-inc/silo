name: "Setup test environment"
description: ""
inputs:
  cachix_auth_token:
    description: "Cachix auth token"
    required: true
outputs: {}
runs:
  using: "composite"
  steps:
    - uses: nixbuild/nix-quick-install-action@v30
    - name: Cachix setup
      uses: cachix/cachix-action@v16
      with:
        name: silo
        authToken: "${{ inputs.cachix_auth_token }}"
    - name: Restore and save Nix store
      uses: nix-community/cache-nix-action@v6
      with:
        primary-key: nix-${{ runner.os }}-${{ hashFiles('**/*.nix', '**/flake.lock') }}
        restore-prefixes-first-match: nix-${{ runner.os }}-
    - run: |
        source <(nix print-dev-env --show-trace) 
        output_file="nix-env.txt"

        # Clear the output file
        > $output_file

        # Loop over each variable in the environment
        while IFS='=' read -r -d '' name value; do
            # Skip if the variable is a function or read-only or non-alphanumeric
            [[ "$(declare -p $name)" =~ "declare -[a-z]*r[a-z]* " ]] && continue
            [[ ! $name =~ ^[a-zA-Z_][a-zA-Z0-9_]*$ ]] && continue

            # Check if the variable value contains a newline
            if [[ "$value" != *$'\n'* ]]; then
                # It doesn't, so write the variable and its value (stripping quotes) to the file
                echo "${name}=${value//\"/}" >> $output_file
            fi
        done < <(env -0)

        # useful for debugging what env is exported
        # cat nix-env.txt
      shell: bash

    - run: cat nix-env.txt >> "$GITHUB_ENV"
      shell: bash
