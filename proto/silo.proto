syntax = "proto3";

package silo.v1;

// Core job messages
message JsonValueBytes {
  bytes data = 1; // raw JSON bytes
}

message RetryPolicy {
  uint32 retry_count = 1;
  int64 initial_interval_ms = 2;
  int64 max_interval_ms = 3;
  bool randomize_interval = 4;
  double backoff_factor = 5;
}

// Per-job concurrency limit declaration
message ConcurrencyLimit {
  string key = 1;             // grouping key; jobs with same key share a limit
  uint32 max_concurrency = 2; // maximum concurrent running jobs for this key
}

message EnqueueRequest {
  string shard = 1; // shard name
  string id = 2; // optional
  uint32 priority = 3; // 0..99, 0 highest
  int64 start_at_ms = 4; // epoch ms
  optional RetryPolicy retry_policy = 5; // optional
  JsonValueBytes payload = 6; // JSON
  repeated ConcurrencyLimit concurrency_limits = 7; // zero or more limits
  optional string tenant = 8; // optional tenant id when tenancy is enabled
  map<string, string> metadata = 9; // arbitrary key/value metadata stored with the job
}

message EnqueueResponse {
  string id = 1;
}

message GetJobRequest { string shard = 1; string id = 2; optional string tenant = 3; }
message GetJobResponse {
  string id = 1;
  uint32 priority = 2;
  int64 enqueue_time_ms = 3;
  JsonValueBytes payload = 4;
  optional RetryPolicy retry_policy = 5; // presence indicates some policy
  repeated ConcurrencyLimit concurrency_limits = 6; // declared limits
  map<string, string> metadata = 7; // arbitrary key/value metadata stored with the job
}

message DeleteJobRequest { string shard = 1; string id = 2; optional string tenant = 3; }
message DeleteJobResponse {}

message LeaseTasksRequest { string shard = 1; string worker_id = 2; uint32 max_tasks = 3; optional string tenant = 4; }
message Task {
  string id = 1; // task id
  string job_id = 2;
  uint32 attempt_number = 3;
  int64 lease_ms = 4; // how long to heartbeat in ms
  JsonValueBytes payload = 5; // job payload for convenience
  uint32 priority = 6;
}
message LeaseTasksResponse { repeated Task tasks = 1; }

message ReportOutcomeRequest {
  string shard = 1;
  string task_id = 2;
  optional string tenant = 5;
  oneof outcome {
    JsonValueBytes success = 3;
    Failure failure = 4;
  }
}
message Failure { string code = 1; bytes data = 2; }
message ReportOutcomeResponse {}

message HeartbeatRequest { string shard = 1; string worker_id = 2; string task_id = 3; }
message HeartbeatResponse {}

// Execute SQL query against shard data
message QueryRequest { 
  string shard = 1; 
  string sql = 2; 
  optional string tenant = 3; 
}

// Column metadata for the result schema
message ColumnInfo {
  string name = 1;
  string data_type = 2; // Arrow/DataFusion type as string (e.g. "Utf8", "Int64", "UInt8")
}

// Query result row as JSON object
message QueryResponse {
  repeated ColumnInfo columns = 1; // Schema information
  repeated JsonValueBytes rows = 2; // Each row is a JSON object
  int32 row_count = 3; // Number of rows returned
}

service Silo {
  rpc Enqueue(EnqueueRequest) returns (EnqueueResponse);
  rpc GetJob(GetJobRequest) returns (GetJobResponse);
  rpc DeleteJob(DeleteJobRequest) returns (DeleteJobResponse);
  rpc LeaseTasks(LeaseTasksRequest) returns (LeaseTasksResponse);
  rpc ReportOutcome(ReportOutcomeRequest) returns (ReportOutcomeResponse);
  rpc Heartbeat(HeartbeatRequest) returns (HeartbeatResponse);
  rpc Query(QueryRequest) returns (QueryResponse);
}


