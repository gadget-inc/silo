version: "0.5"

processes:
  etcd:
    command: |
      etcd \
        --name silo-dev \
        --data-dir ./tmp/etcd-data \
        --listen-client-urls http://127.0.0.1:2379 \
        --advertise-client-urls http://127.0.0.1:2379 \
        --listen-peer-urls http://127.0.0.1:2380 \
        --initial-advertise-peer-urls http://127.0.0.1:2380 \
        --initial-cluster silo-dev=http://127.0.0.1:2380 \
        --initial-cluster-token silo-dev-token \
        --initial-cluster-state new
    readiness_probe:
      http_get:
        host: 127.0.0.1
        port: 2379
        path: /health
      initial_delay_seconds: 1
      period_seconds: 2
    shutdown:
      timeout_seconds: 2
    availability:
      restart: always
      backoff_seconds: 2

  gubernator:
    command: gubernator
    environment:
      - GUBER_GRPC_ADDRESS=127.0.0.1:9992
      - GUBER_HTTP_ADDRESS=127.0.0.1:9982
      - GUBER_MEMBERLIST_ADDRESS=127.0.0.1:7947
      - GUBER_MEMBERLIST_BIND_ADDRESS=127.0.0.1:7947
      - GUBER_MEMBERLIST_KNOWN_NODES=127.0.0.1:7947
    readiness_probe:
      http_get:
        host: 127.0.0.1
        port: 9982
        path: /v1/HealthCheck
      initial_delay_seconds: 1
      period_seconds: 2
    shutdown:
      timeout_seconds: 1
    availability:
      restart: always
      backoff_seconds: 1

  # Toxiproxy server for network fault injection testing
  toxiproxy:
    command: toxiproxy-server -host 127.0.0.1 -port 8474 -config $TOXIPROXY_CONFIG
    readiness_probe:
      http_get:
        host: 127.0.0.1
        port: 8474
        path: /version
      initial_delay_seconds: 1
      period_seconds: 2
    shutdown:
      timeout_seconds: 1
    availability:
      restart: always
      backoff_seconds: 1

  # Silo instance 1 - watchexec restarts cargo run on source changes
  silo-1:
    command: |
      watchexec \
        --restart \
        --stop-signal SIGTERM \
        --stop-timeout 1 \
        --watch src \
        --watch proto \
        --watch Cargo.toml \
        --ignore target \
        --ignore tmp \
        --ignore '*.lock' \
        -- cargo run --bin silo -- -c example_configs/dev-node1.toml
    depends_on:
      etcd:
        condition: process_healthy
      gubernator:
        condition: process_healthy
    shutdown:
      timeout_seconds: 1
    availability:
      restart: always
      backoff_seconds: 1
    log_location: ./tmp/silo-1.log
    log_configuration:
      rotation:
        max_size_mb: 5
        max_age_days: 3
        max_backups: 1

  # Silo instance 2 - watchexec restarts cargo run on source changes
  silo-2:
    command: |
      watchexec \
        --restart \
        --stop-signal SIGTERM \
        --stop-timeout 1 \
        --watch src \
        --watch proto \
        --watch Cargo.toml \
        --ignore target \
        --ignore tmp \
        --ignore '*.lock' \
        -- cargo run --bin silo -- -c example_configs/dev-node2.toml
    depends_on:
      etcd:
        condition: process_healthy
      gubernator:
        condition: process_healthy
    shutdown:
      timeout_seconds: 1
    availability:
      restart: always
      backoff_seconds: 1
    log_location: ./tmp/silo-2.log
    log_configuration:
      rotation:
        max_size_mb: 5
        max_age_days: 3
        max_backups: 1
